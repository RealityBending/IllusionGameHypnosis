<!-- Load jsPsych 7.3.1 (last updated: 19/10/1991)-->
<!DOCTYPE html>
<html>

<head>
    <!--create title shown in tab; not the same as header on webpage-->
    <title>RestingState</title>

    <script src="utils/jspsych/jspsych.js"></script>

    <!--Load all necessary plugins stored in utils-->
    <script src="utils/jspsych/plugin-html-keyboard-response.js"></script>
    <script src="utils/jspsych/plugin-browser-check.js"></script>
    <script src="utils/jspsych/plugin-html-button-response.js"></script>
    <script src="utils/jspsych/plugin-fullscreen.js"></script>
    <script src="utils/jspsych/plugin-survey-text.js"></script>
    <script src="utils/jspsych/plugin-audio-button-response.js"></script>
    <script src="utils/jspsych/plugin-canvas-button-response.js"></script>
    <script src="utils/jspsych/plugin-preload.js"></script>
    <script src="utils/jspsych/multiple-slider.js"></script>
    <script src="utils/jspsych/extension-record-video.js"></script>
    <script src="utils/jspsych/plugin-initialize-camera.js"></script>
    <script src="parameters.js"></script>

    <!-- Applying default style here -->
    <link href="utils/jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
        /* set canvas to be full screen */
        .jspsych-content {
            max-width: 100%;
        }

        /*Hide scrollbar while keeping it functional */
        body {
            overflow-y: scroll;
        }

        Body::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body></body>

<script>
    /* ----------------- Initialize experiment ----------------- */
    var timeline = []

    var extensions = []
    if (record_webcam == true) {
        extensions.push({ type: jsPsychExtensionRecordVideo })
    }

    var jsPsych = initJsPsych({
        extensions: extensions,
        // override_safe_mode: true,
        on_finish: function () {
            if (raw_data == true) {
                jsPsych.data.allData.trials = [clean_data()]
            }
            // jsPsych.data.displayData("json")
            jsPsych.data
                .get()
                .localSave(
                    "json",
                    `${jsPsych.data.get().values()[0]["participant_id"]
                    }_RestingState.json`
                )
        },
    })

    // Enter fullscreen mode
    timeline.push({
        type: jsPsychFullscreen,
        fullscreen_mode: true,
        delay_after: 0,
    })

    // Webcam initialization (can be activated in parameters.js)
    if (record_webcam == true) {
        timeline.push({
            type: jsPsychInitializeCamera,
        })
    }

    /* ----------------- Session Info ----------------- */

    // Participant information
    var participant_info = {
        type: jsPsychSurveyText,
        questions: [
            {
                prompt: "Enter the participant's ID:",
                placeholder: "S00",
                name: "Participant_ID",
            },
        ],
        data: {
            screen: "participant_info",
            version: version,
            date: new Date().toLocaleDateString("fr-FR"),
            time: new Date().toLocaleTimeString("fr-FR"),
        },
        on_finish: function () {
            jsPsych.data.addProperties({
                participant_id: jsPsych.data.get().last().values()[0][
                    "response"
                ]["Participant_ID"],
            })
        },
    }
    timeline.push(participant_info)

    /* ----------------- Preloading ----------------- */
    // Preload audio variables
    var beep = ["utils/beep.mp3"]
    timeline.push({
        type: jsPsychPreload,
        auto_preload: true,
        audio: beep,
    })

    /* ----------------- Experiment Variables ----------------- */
// Mini IPIP6 questionnaire
var scale = [ "1",
                        "2",
                        "3",
                        "4",
                        "5",
                        "6",
                        "7",]
            var questions = []
            for (const [index, element] of ipip6_items.entries()) {
                questions.push({
                    prompt: "<b>" + element + "</b>",
                    name: ipip6_dimensions[index],
                    ticks: scale,
                    required: questions_required,
                })
            }

            var ipip6 = {
                type: jsPsychMultipleSlider,
                questions: questions,
                randomize_question_order: true,
                preamble:
                    "<h2>ipip6</h2>",
                require_movement: questions_required,
                slider_width: null,
                min: 1,
                max: 7,
                slider_start: 4,
                step: 10,
                ticks: scale,
                data: {
                    screen: "ipip6_dimensions",
                },
            }
            timeline.push(ipip6)

    // Instructions
    var instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus:
            "<p><b>Instructions</b></p>" +
            // Don't give exact time so that participants don't count
            "<p>A rest period of about 10 minutes is about to start.</p>" +
            "<p>Simply <b>relax</b> and remain seated quietly with your eyes closed. Please try <b>not to fall asleep</b>.</p> " +
            "<p>Once the resting period is over, you will hear a beep. You can then open your eyes and proceed.</p>" +
            "<p>Once you are ready, close your eyes. The rest period will shortly begin.</p>",
        choices: ["Continue"],
    }
    timeline.push(instructions)

    function create_marker(marker_position, color = "black") {
        const html = `<div id="marker" style="position: absolute; background-color: ${color};\
        left:${marker_position[0]}px; top:${marker_position[1]}px; \
        width:${marker_position[2]}px; height:${marker_position[3]}px";></div>`
        document.querySelector("body").insertAdjacentHTML("beforeend", html)
    }

    // Create blank grey screen just before rest period
    var buffer = {
        type: jsPsychHtmlKeyboardResponse,
        on_start: function () {
            document.body.style.backgroundColor = "#808080"
            document.body.style.cursor = "none"
            create_marker(marker_position, (color = "white"))
        },
        on_finish: function () {
            document.querySelector("#marker").remove()
        },
        stimulus: "",
        choices: ["s"],
        trial_duration: 1000, // 1 second
        css_classes: ["fixation"],
    }
    timeline.push(buffer)

    // Create blank grey screen for resting state
    var rest = {
        type: jsPsychHtmlKeyboardResponse,
        extensions: extensions,
        on_load: function () {
            create_marker(marker_position)
        },
        stimulus: "<p style='font-size:150px;'>+</p>",
        choices: ["s"],
        trial_duration: duration * 60 * 1000,
        css_classes: ["fixation"],
        data: {
            screen: "resting",
            time_start: function () {
                return performance.now()
            },
        },
        on_finish: function (data) {
            document.querySelector("#marker").remove()
            data.duration =
                (performance.now() - data.time_start) / 1000 / 60
        },
    }
    timeline.push(rest)

    var audio_trigger = {
        type: jsPsychAudioButtonResponse,
        on_start: function () {
            document.body.style.backgroundColor = "#FFFFFF"
            document.body.style.cursor = "auto"
        },
        stimulus: beep,
        prompt: "<p>It's over! Please press continue.</p>",
        choices: ["Continue"],
    }
    timeline.push(audio_trigger)

   




  // PID-5-BF questionnaire
    var scale = ["Completely Disagree", "Completely Agree"]
    var questions = []
    for (const [index, element] of PID5_items.entries()) {
        questions.push({
            prompt: "<b>" + element + "</b>",
            name: PID5_dimensions[index],
            ticks: scale,
            required: questions_required,
        })
    }
    questions = jsPsych.randomization.shuffle(questions)


    var PID5 = {
        type: jsPsychMultipleSlider, // this is a custom plugin in utils
        questions: questions,
        randomize_question_order: true,
        preamble:
            "<p>PID5</p>",
        require_movement: questions_required,
        slider_width: null,
        min: 0,
        max: 1,
        slider_start: 0.5,
        data: {
            screen: "PID5",
        },
    }
    timeline.push(PID5)

     

    // Debriefing and exit fullscreen
    timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: "You've reached the end of the task, thank you!",
        choices: ["Exit Fullscreen"],
        on_finish: function () {
            document.exitFullscreen()
        },
    })

    // Exit fullscreen mode
     timeline.push({
        type: jsPsychFullscreen,
        fullscreen_mode: false,
    })
    
    /* ----------------- Run the timeline ----------------- */
    jsPsych.run(timeline)

    function clean_data() {
        if (record_webcam == true) {
            items["video"] = jsPsych.data
                .get()
                .filter({ screen: "resting" })
                .values()[0]["record_video_data"]
        }
    }
</script>

</html>
