<head>
    <!-- Customize the title! -->
    <title>Illusion Game</title>
    <!-- jsPsych Scripts -->
    <script src="utils/jspsych/jspsych.js"></script>
    <script src="utils/jspsych/plugin-html-keyboard-response.js"></script>
    <script src="utils/jspsych/plugin-html-button-response.js"></script>
    <script src="utils/jspsych/plugin-fullscreen.js"></script>
    <script src="utils/jspsych/plugin-audio-button-response.js"></script>
    <script src="utils/jspsych/plugin-survey-text.js"></script>
    <script src="utils/jspsych/plugin-preload.js"></script>
    <script src="utils/jspsych/plugin-image-keyboard-response.js"></script>
    <script src="utils/jspsych/plugin-survey-multi-choice.js"></script>
    <script src="utils/jspsych/plugin-browser-check.js"></script>
    <script src="utils/jspsych/plugin-survey-likert.js"></script>

    <!-- Other modules -->
    <script src="utils/JSmisc.js"></script>
    <!-- <script src="https://realitybending.github.io/JSmisc/misc/utils.js"></script> -->
    <!--<script src = "utils/jspsych/plugin-jsPsychPavlovia.js"></script>-->
    <!--<script src = "utils/jspsych/plugin-jspsych-pavlovia-2021.js"></script>-->
    <!-- Load stimuli -->
    <script src="stimuli/stimuli_training.js"></script>
    <script src="stimuli/stimuli_part1.js"></script>
    <script src="stimuli/stimuli_part2.js"></script>

    <script src="experiment.js"></script>
    <script src="utils/plugin-survey-multiple-slider.js"></script>
    <!-- CSS -->
    <link href="utils/jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <!--<script type="text/javascript" src="lib/vendors/jquery-2.2.0.min.js"></script>-->
    <!--<script type="text/javascript" src="lib/jspsych-7-pavlovia-2022.1.1.js"></script>-->


    <style>
        /* set canvas to be full screen */
        .jspsych-content {
            max-width: 100%;
        }

        /*Hide scrollbar while keeping it functional */
        body {
            overflow-y: scroll;
            overflow-x: flow;
        }

        Body::-webkit-scrollbar {
            display: none
        }
    </style>
</head>

<body></body>



<script>


    /* ----------------- Initialize experiment ----------------- */
    var timeline = []

    var jsPsych = initJsPsych({
        show_progress_bar: true,
        message_progress_bar: "Completion",
        // exclusions: { min_width: 800, min_height: 600 }, /* exclude browsers that are not at least 800x600 pix */
        //  on_interaction_data_update: function (data) {console.log(JSON.stringify(data))}, /* record browser interactions */
        on_finish: function () {
            // jsPsych.data.displayData("json")
            jsPsych.data
                .get()
                .localSave(
                    "json",
                    `${jsPsych
                        .data
                        .get()
                        .values()[0]["subject_id"]
                    }_IllusionGameEEG.json`
                )
        },
    })

    // Fullscreen mode
    timeline.push({
        type: jsPsychFullscreen,
        fullscreen_mode: true,
        delay_after: 0,
    })

    // Retrieve and save browser info
    var browser_check = {
        type: jsPsychBrowserCheck,
        data: {
            screen: "browser_info",
            version: "1.0",
            date: new Date().toLocaleDateString("fr-FR"),
            time: new Date().toLocaleTimeString("fr-FR"),
        },
        on_finish: function () {
            data = jsPsych.data.get().filter({ screen: "browser_info" }).values()[0]
            jsPsych.data.addProperties({
                ["screen_height"]: data["height"],
                ["screen_width"]: data["width"],
            })
            for (var key in data) {
                if (
                    [
                        "vsync_rate",
                        "os",
                        "mobile",
                        "browser",
                        "browser_version",
                    ].includes(key)
                ) {
                    jsPsych.data.addProperties({
                        [key]: data[key],
                    })
                }
            }
            jsPsych.data.addProperties()
        },
    }
    timeline.push(browser_check)

    /* ----------------- Preloading Audio ----------------- */
    // Preload audio variables
    var beep = ["utils/beep.mp3"]
    timeline.push({
        type: jsPsychPreload,
        auto_preload: true,
        audio: beep,
    })

    initJsPsych({
        override_safe_mode: true
    });

    /* ----------------- Experiment  ----------------- */

    // Subject Information
    var participant_id = jsPsych.randomization.randomID(6)
    jsPsych.data.addProperties({ participant_id: participant_id })

    var subject_id = {
        type: jsPsychSurveyText,
        questions: [
            {
                prompt: "Enter the participant's ID:",
                name: "subject_id",
                required: true,
            },
        ],
        data: {
            screen: "subject_id",
        },
        on_finish: function () {
            jsPsych.data.addProperties({
                subject_id: jsPsych.data.get().last().values()[0][
                    "response"
                ]["subject_id"],
            })
        },
    }

    timeline.push(subject_id)


    // Introduction to Mindfulness audio
    var mindfullness_intro = {
        type: jsPsychHtmlButtonResponse,
        choices: ["Start audio"],
        stimulus:
            "<p>Before continuing with the final part of the experiment, there will be a short mindfullness session</p>" +
            "<p>After pressing the button to start the audio clip please close your eyes and focus on the voice</p><br>" +
            "<p>It is easy for the mind to wander however try and use this time to enjoy some mindfulness, studies show a brief moment of mindfulness in our day can alleviate stresses aswell as helping our attentional focus and task performance</p>" +
            "<p>After the audio clip there will  be another set of trials, however there will be no practice rounds so your speed and accuracy will be measured from the start" +
            "<p>Enjoy the mindfullness session!</p><br>",
        data: { screen: "Mindfulness Session" },
    }

    timeline.push(mindfullness_intro)

    // Mindfullness audio
    var mindfullness_audio = {
        type: jsPsychAudioButtonResponse,
        stimulus: beep,
    }
    timeline.push(mindfullness_audio)


    /* ============================================================== */
    /*  -----------------------TASK BLOCKS---------------------------*/
    /* ============================================================== */
    // Set experiment variables
    var trial_number = 1 // trial indexing variable starts at 1 for convenience
    var block_number = 1 // block indexing variable

    for (var i of [1, 2]) {
        if (i === 1) {
            stimuli = stimuli_part1
        } else {
            stimuli = stimuli_part2
        }

        /* ================================================================ */
        /* ---------------------- MULLERLYER ILLUSION --------------------- */
        /* ================================================================ */
        var timeline_mullerlyer = make_trial(stimuli,
            (instructions = function () {
                return "<p><b>Part " +
                    block_number +
                    "/6" +
                    "</b></p>" +
                    mullerlyer_instructions
            }),
            (illusion_name = "MullerLyer"),
            (type = "updown")
        )

        /* ================================================================ */
        /* --------------------- EBBINGHAUS ILLUSION ---------------------- */
        /* ================================================================ */
        var timeline_ebbinghaus = make_trial(stimuli,
            (instructions = function () {
                return "<p><b>Part " +
                    block_number +
                    "/6" +
                    "</b></p>" +
                    ebbinghaus_instructions
            }),
            (illusion_name = "Ebbinghaus"),
            (type = "leftright")
        )

        /* ================================================================ */
        /* ----------------- VERTICAL-HORIZONTAL ILLUSION ----------------- */
        /* ================================================================ */
        var timeline_verticalhorizontal = make_trial(stimuli,
            (instructions = function () {
                return "<p><b>Part " +
                    block_number +
                    "/6" +
                    "</b></p>" +
                    verticalhorizontal_instructions
            }),
            (illusion_name = "VerticalHorizontal"),
            (type = "leftright")
        )



        /* ================================================================ */
        /* ---------------------- END OF EXPERIMENT ----------------------- */
        /* ================================================================ */
        for (var t of jsPsych.randomization.shuffleNoRepeats([
            timeline_mullerlyer,
            timeline_ebbinghaus,
            timeline_verticalhorizontal,
        ])) {
            timeline.push({ timeline: t })
        }
    }


    // Debriefing Information
    var end_experiment = {
        type: jsPsychHtmlButtonResponse,
        choices: ["End"],
        stimulus: function () {
            var results = get_results(
                1000, // population_scores["Total"]["IES_Mean"][0],
                400 // population_scores["Total"]["IES_SD"][0]
            )
            var show_screen = get_debrief_display(results, "Final")
            return (
                //show_screen.display_score +
                // "<hr>" +
                // show_screen.display_comparison +
                //"<hr>" +
                "<p>Thank you for participating!</p>" +
                "<p>Please inform the experimenter that you have completed the experiment.</p>"
            )
        },
        data: { screen: "final_results" },
    }
    timeline.push(end_experiment)

    // Fullscreen mode
    timeline.push({
        type: jsPsychFullscreen,
        fullscreen_mode: false,
    })

    jsPsych.run(timeline)



</script>

</html>